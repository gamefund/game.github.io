/**
 * 交配页面
 */
var sale_sireInit = function (kitty_id, kitty_type) {
    $("body").empty();
    indexArray.push("sale_sireInit");
    headerInit("sale_sire", kitty_id, kitty_type);
    $("body").append(sale_sireText);


    $(".sale-sire-container .sire-small-title .sire-to-public").click(function(){
        if($(this).hasClass("sale-sire-selected")){
            return;
        }
        $(".my-kitties-choose").remove();
        $(".finish-setting-button").before(publicSireText);
        $(this).addClass('sale-sire-selected');
        $(".sale-sire-container .setting-button").unbind("click");
        $(".sale-sire-container .setting-button").click(function(){
            var start_price = $(".input-starting-price").val();
            var end_price = $(".input-end-price").val();
            var duration = $(".input-duration").val();
            var kitty_id = kitty_id;
            release_sire(kitty_id,start_price,end_price,duration);
        });
        $(".sale-sire-container .sire-small-title .sire-with-ownKitties").removeClass('sale-sire-selected'); 
    });
    $(".sale-sire-container .sire-small-title .sire-with-ownKitties").click(function(){
        if($(this).hasClass("sale-sire-selected")){
            return;
        }
        $(".setting-starting-price").remove();
        $(".setting-end-price").remove();
        $(".setting-duration").remove();
        $(".finish-setting-button").before(ownerSireText);
        $(".choose-kitty-input").append(my_kittiesSelect);
        getNotSiredKitties();
        $(".sale-sire-container .setting-button").unbind("click");
        $(".sale-sire-container .setting-button").click(function(){
            var sId = kitty_id;
            var mId = $(".choose-kitty-input select").val();
            console.log(mId);
            to_sire(sId,mId);
        });
        $(this).addClass('sale-sire-selected');
        $(".sale-sire-container .sire-small-title .sire-to-public").removeClass('sale-sire-selected'); 
    });

    $(".sale-sire-container .setting-button").click(function(){
        var start_price = $(".input-starting-price").val();
        var end_price = $(".input-end-price").val();
        var duration = $(".input-duration").val();
        var kitty_id = kitty_id;
        release_sire(kitty_id,start_price,end_price,duration);
    });

};

var my_kittiesSelect =
    '<select validateevent="true" onchange="chooseSireKitty()">' +
    '<option value="">Please choose your Kitty</option>' +
    '</select>';

var ownerSireText =
    '<div class="my-kitties-choose">'+
        '<div class="choose-kitty-text">Choose A Kitty</div>' +
        '<div class="choose-kitty-input">' +
        '</div>' +
    '</div>';

var publicSireText =
    '<div class="setting-starting-price">' +
        '<div class="setting-starting-price-text">Enter start price</div>' +
        '<div class="setting-starting-price-input">' +
            '<span></span>' +
            '<input type="number" class="input-starting-price " placeholder="1" />' +
        '</div>' +
    '</div>' +

    '<div class="setting-end-price">' +
        '<div class="setting-end-price-text">Enter end price</div>' +
        '<div class="setting-end-price-input">' +
            '<span></span>' +
            '<input type="number" class="input-end-price " placeholder="0.5" />' +
        '</div>' +
    '</div>' +

    '<div class="setting-duration">' +
        '<div class="setting-duration-text">Duration</div>' +
        '<div class="setting-duration-input">' +
            '<span>Days</span>' +
            '<input type="number" class="input-duration " placeholder="2" />' +
        '</div>' +
    '</div>';


/**
 * 销售页面
 */
var sale_sellInit = function (kitty_id, kitty_type) {
    $("body").empty();
    indexArray.push("sale_sellInit");
    headerInit("sale_sell", kitty_id, kitty_type);
    $("body").append(sale_sellText);


     $(".sale-sell-container .setting-button").click(function(){
         console.log(456)
         goToShop(kitty_id)
     });

};
/**
 * 上架kitty
 */
var goToShop = function(kitty_id) {
    var startPrice = $('.input-starting-price').val();
    var endPrice = $('.input-end-price').val();
    var duration = $('.input-duration').val();
    var seller_id = userId;
    var kitty_id = kitty_id;
    var type = 1;
    $.ajax({
        url: Config.address + "sellKitties",
        type: "POST",
        data: {
            start_price:  startPrice/ethRate,
            type: type,
            end_price: endPrice/ethRate,
            duration: duration,
            seller_id: seller_id,
            kitty_id: kitty_id,
        },
        success: function (response) {
            console.info(response);
            if (response.state == "5") {
                alert("Sell To MarketPlace Success!");
            }

        },
        error: function (error) {
            console.info(error);
            alert("Sell To MarketPlace Filed!");
        }
    });
}


var release_sire = function(kitty_id,start_price,end_price,duration){
    $.ajax({
        url: Config.address + "sire/releaseSireKitty",
        type: "POST",
        data: {
            "kitty_id":  10,
            "type": 2,
            "start_price": start_price/ethRate,
            "end_price": end_price/ethRate,
            "duration": duration,
        },
        success: function(response){
            console.info(response);
            marketInit();
        },
        error: function(error){
            console.info(error);
        }
    });
}

//查询我的能够交配的猫
var getMyKitties = function (my_kitties) {
    //我的猫数据 my_kitties
    for (var index in my_kitties) {
        var optionContent;
        try {
            optionContent = "undefined"==typeof(my_kitties[index].name)? ("Kitty #"+my_kitties[index].id):my_kitties[index].name;
        } catch (e) {
            console.log(e);
        }
        var my_kittiesText =
            '<option value="' + my_kitties[index].id + '">'+optionContent+'</option>';
        $(".choose-kitty-input select").append(my_kittiesText);
    }
};

var getNotSiredKitties = function(){
    $.ajax({
        url: Config.address + "sire/getNotSiredKitties",
        type: "POST",
        data: {
            "kittyId":  10,
            "uId": userId
        },
        success: function(response){
            console.log(response.msg);
            getMyKitties(response.msg);
        },
        error: function(error){
            console.info(error);
        }
    });
}

var to_sire = function(sId,mId,uId){
    $.post(Config.address + "sire/toSire", {
        sId: sId,
        mId: mId,
        uId: userId,
    }, function (data) {
        addWaitView();
        showWaitView();
        createShowChildCanvas(data);
        console.log(data);
    }, "json");
}

//隱藏展示的小kitty界面
var hideChildView = function () {
    index = 0;
    $(".div-show-child").remove();
    marketInit();
};

/**
 * 赠送kitty页面
 * @param kitty_id
 */
var sale_giftInit = function (kitty_id, kitty_type) {
    $("body").empty();
    indexArray.push("sale_giftInit");
    headerInit("sale_gift", kitty_id, kitty_type);
    $("body").append(sale_giftText);


    $(".sale-sell-container .setting-button").click(function(){
        // console.log(456);
        var kId = kitty_id;
        var rId = $(".input-duration").val();
        $.ajax({
            url: Config.address + "giftKitty",
            type: "POST",
            data: {
                "type": 0x0011,
                "uId":  userId,
                "kId": kId,
                "rId": rId,
            },
            success: function(response){
                console.log(response);
                marketInit();
            },
            error: function(error){
                console.info(error);
                alert("Send Kitty Filed! It's Not My Fault!");
            }
        });
    });
}

    