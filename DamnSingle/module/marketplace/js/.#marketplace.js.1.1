/**
 * 交易所
 */
var marketInit = function () {
    $("body").empty();
    console.log(data);
    headerInit(data);
    $("body").append(marketText);

    var OperateType = {
        REFRESH: 0x0001, //刷新界面
        OPEN_EXCHANGE: 0x0002, //打开交易所
        OPEN_DETAIL: 0x0003, //打开详情界面
        KITTIES: 0x0004, //谁的猫界面
    };

    fillMarketPageData(data);

    //显示的猫的数量
    $(".searchOrFilter-number .cats-number").text(data.kitties_count);

    //点击类型筛选
    $(".marketplace-filter").click(function () {
        console.log("111")
        $(".marketplace-filter-displayArea").toggle();
    })

    //点击for sale
    $(".marketplace-classify .for-sale").click(function () {
        if ($(this).hasClass("classify-title-active")) {
            return;
        }
        console.log("222");
        //请求销售的猫数据 data

        fillMarketPageData(data);
        $(this).addClass('classify-title-active').siblings().removeClass('classify-title-active');
    })
    //点击siring
    $(".marketplace-classify .for-siring").click(function () {
        if ($(this).hasClass("classify-title-active")) {
            return;
        }
        console.log("222");
        //请求交配的猫数据 data

        fillMarketPageData(data);
        $(this).addClass('classify-title-active').siblings().removeClass('classify-title-active');
    })
    //点击Gen 0
    $(".marketplace-classify .for-Generation-0").click(function () {
        if ($(this).hasClass("classify-title-active")) {
            return;
        }
        console.log("222");
        //请求Gen 0的猫数据 data

        fillMarketPageData(data);
        $(this).addClass('classify-title-active').siblings().removeClass('classify-title-active');
    })
    //点击All kitties
    $(".marketplace-classify .for-all").click(function () {
        if ($(this).hasClass("classify-title-active")) {
            return;
        }
        console.log("222");
        //请求所有猫数据 data

        fillMarketPageData(data);
        $(this).addClass('classify-title-active').siblings().removeClass('classify-title-active');
    })



    //分页组件的使用
    $('#page').pagination({
        totalData: data.kitties_count,
        showData: data.limit,
        // jump:true,
        coping: true,
        // homePage:'首页',
        // endPage:'末页',
        // prevContent:'Preview',
        // nextContent:'Next'
    });


};

//价格单位转换
var priceConversion = function (price) {
    var conversedPrice = parseInt(price) * ethRate;
    return conversedPrice.toFixed(3);
}

//添加页面数据
var fillMarketPageData = function (data) {
    for (var i = 0; i < data.kitties.length; i++) {
        var text = '<div class="kitty-library-item">' +
            '<a href=""></a>' +
            '<div class="kitty-item-container">' +
            '<div class="kitty-item" onclick="jumpNextPage(event)" id="index' + i + '">' +
            

            '<div class="kitty-item-newBadge">' +
            '<div class="triangle-newBadge">' +
            '<div class="triangle-text">New</div>' +
            '</div>' +
            '</div>' +
            "<div class=\"kitty-item-photo\" style=\"background-image=\"http://192.168.1.151:8080/kitties/111.png\"\" ></div>" +
            '</div>' +
            
            '<div class="kitty-item-details">' +
            '<span class="kitty-item-details-item">' + 'Kitty ' + data.kitties[i].kitty.id + '</span>' +
            '<span class="kitty-item-details-item">' + ' - Gen ' + data.kitties[i].kitty.generation + '</span>' +
            '<span class="kitty-item-details-item">' + ' - ' + cooldown[data.kitties[i].status.cooldown_index] + '</span>' +
            '</div>' +
            '<div class="kitty-item-actions">' +
            '<div class="kitty-item-actions-action">' +
            '<span class="kitty-item-actions-icon">' + 'zan ' + '</span>' +
            '<span class="kitty-item-actions-number">' + data.kitties[i].purrs.count + '</span>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';

        var status_text = null;
        switch (data.kitties[i].type) {
            case "sale":
                status_text = "For sale";
                break;
            case "sire":
                status_text = "Wants to sire";
                break;
        }
        var childText = '<div class="kitty-item-status">' +
            '<div class="status-item">' +
            '<span class="status-itemIcon"></span>' +
            '<span class="status-itemText">' + status_text + ' - ' + '</span>' +
            '<span class="status-itemprice">' + priceConversion(data.kitties[i].current_price) + '</span>' +
            '</div>' +
            '</div>';

        $(".marketplace-content-library .library-container .kitty-library").append(text);

        if (isNaN(data.kitties[i].type)) {
            $(".kitty-library-item:last .kitty-item-container .kitty-item .kitty-item-photo").prepend(childText);
        }

        $(".kitty-library-item .kitty-item-container .kitty-item-actions .kitty-item-actions-icon").click(function () {
            var zan = parseInt(data.kitties[i].purrs.count) + 1
            data.kitties[i].purrs.count = zan;
        })


        var newBadgeText = ''

        $("#index" + i).data("indexData", data.kitties[i]);

        // $("#index"+i).click(function(){
        //     //跳转页面
        //     // kittyInit(kitty_detail);
        //     console.log(i);
        //     jumpNextPage(data.kitties[i].kitty.id);
        // });
    }
};

//点击不同类型kitty 跳转至不同的页面
var jumpNextPage = function (e) {
    var chooseData = $(e.target).data("indexData");
    if (chooseData.type == "sale") { //请求购买猫信息
        kittyInit(kitty_detail);
    } else if (chooseData.type == "sire") { //请求可交配猫信息
        kittyInit(kitty_detail);
    } else { //猫详情页面
        kittyInit(kitty_detail);
    }
}